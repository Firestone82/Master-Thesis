name: Compile LaTeX

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  check-markdown:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: DavidAnson/markdownlint-cli2-action@v13.0.0
        with:
          fix: true
          globs: '**/*.md'

  build-latex:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Fake display for plantuml
      - name: Set up Xvfb
        run: |
          sudo apt-get install -y xvfb
          sudo Xvfb :99 -ac -screen 0 1024x768x8 &
          export DISPLAY=:99

      - name: Compiling LaTeX documents
        uses: xu-cheng/latex-action@v4
        with:
          root_file: main.tex
          working_directory: src
          args: -pdf -halt-on-error -synctex=1 -interaction=nonstopmode --shell-escape --enable-write18
          extra_system_packages: 'inkscape openjdk17'
          latexmk_use_xelatex: true

      - name: Upload LaTeX documents to artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: MIK0486-Thesis
          path: src/main.pdf
          if-no-files-found: error

      - name: Publish PDF to GitHub release
        if: github.event_name != 'pull_request'
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Latest Thesis PDF
          body: Automatically updated thesis PDF from `${{ github.ref_name }}`.
          allowUpdates: true
          removeArtifacts: true
          artifacts: src/main.pdf

      - name: Build GitHub Pages site
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p pages
          cp src/main.pdf pages/main.pdf
          cat > pages/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <title>Thesis PDF</title>
            <style>
              html, body {
                margin: 0;
                height: 100%;
                background: #111;
              }
              object {
                width: 100%;
                height: 100%;
                border: 0;
              }
            </style>
          </head>
          <body>
            <object data="main.pdf" type="application/pdf">
              <p>Unable to display PDF in browser.
              <a href="main.pdf">Download the thesis PDF</a>.</p>
            </object>
          </body>
          </html>
          HTML

      - name: Upload Pages artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

  deploy-pages:
    if: github.event_name != 'pull_request'
    needs: build-latex
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4